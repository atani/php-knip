# ADR-0002: EUC-JP/Shift_JISエンコーディング対応

## ステータス

採用済み (Accepted)

## コンテキスト

日本の企業で運用されているレガシーPHPプロジェクトの多くは、EUC-JPやShift_JISエンコーディングで書かれている。既存のデッドコード検出ツール（knip等）はUTF-8のみを前提としており、これらのプロジェクトでは使用できない。

PHP-Knipの差別化ポイントとして、日本のレガシーシステムへの対応が求められた。

## 決定

以下のエンコーディング対応戦略を採用する：

1. **自動検出機構の実装**
   - BOM（Byte Order Mark）による検出
   - `declare(encoding='...')` 文の解析
   - mbstringによる統計的検出

2. **UTF-8への変換パイプライン**
   - 解析前にUTF-8へ変換
   - php-parserはUTF-8のみを処理
   - 出力時はUTF-8で統一

3. **対応エンコーディング**
   - UTF-8（BOMあり/なし）
   - EUC-JP
   - Shift_JIS (CP932)
   - ISO-2022-JP

## 理由

### UTF-8変換アプローチを選んだ理由

| アプローチ | メリット | デメリット |
|-----------|---------|-----------|
| **UTF-8変換（採用）** | php-parserをそのまま使用可能、実装がシンプル | 変換オーバーヘッド |
| マルチエンコーディングパーサー | 変換不要 | php-parserの大規模改修が必要 |
| 独自パーサー実装 | 完全制御可能 | 開発コスト大、バグリスク |

### 検出優先順位

1. BOM - 最も確実
2. declare文 - PHPの仕様に準拠
3. mbstring検出 - フォールバック

この優先順位により、明示的な指定を尊重しつつ、指定がない場合でも適切に動作する。

## 影響

### ポジティブ
- 日本のレガシーシステムでの利用が可能に
- 他ツールとの差別化
- PHP 5.6時代のプロジェクトでも動作

### ネガティブ
- ext-mbstring依存（推奨）
- 大規模ファイルでの変換オーバーヘッド
- 文字化けリスク（検出失敗時）

### 緩和策
- `--encoding` オプションで強制指定可能
- 変換失敗時の明確なエラーメッセージ
- キャッシュ機構による再変換の回避（将来）

## 参考

- [PHP declare文](https://www.php.net/manual/ja/control-structures.declare.php)
- [mbstring](https://www.php.net/manual/ja/book.mbstring.php)
